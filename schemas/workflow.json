{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Workflow",
  "description": "Represents a workflow definition",
  "type": "object",
  "properties": {
    "nodes": {
      "description": "Nodes in the workflow",
      "type": "array",
      "items": {
        "$ref": "#/$defs/Node"
      }
    },
    "params": {
      "description": "Params schema definition",
      "anyOf": [
        {
          "$ref": "#/$defs/WorkflowParams"
        },
        {
          "type": "null"
        }
      ],
      "default": null
    },
    "state": {
      "description": "State schema definition",
      "anyOf": [
        {
          "$ref": "#/$defs/WorkflowState"
        },
        {
          "type": "null"
        }
      ],
      "default": null
    },
    "templates": {
      "description": "Templates for reusable components",
      "type": "array",
      "default": [],
      "items": {
        "$ref": "#/$defs/Template"
      }
    },
    "version": {
      "description": "Version of the workflow format",
      "type": "string"
    }
  },
  "required": [
    "version",
    "nodes"
  ],
  "$defs": {
    "Node": {
      "description": "Represents a node in a workflow",
      "type": "object",
      "properties": {
        "depends_on": {
          "description": "IDs of nodes that must complete before this node can run",
          "type": "array",
          "default": [],
          "items": {
            "type": "string"
          }
        },
        "description": {
          "description": "Detailed description of what the node does",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "env": {
          "description": "Environment variables to inject into the container",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "id": {
          "description": "Unique identifier for the node",
          "type": "string"
        },
        "name": {
          "description": "Human-readable name",
          "type": "string"
        },
        "runtime": {
          "description": "Container runtime configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/Runtime"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "steps": {
          "description": "Steps to execute within the node",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Step"
          }
        },
        "strategy": {
          "description": "Configuration for running multiple instances of this node",
          "anyOf": [
            {
              "$ref": "#/$defs/Strategy"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "trigger": {
          "description": "Configuration for how the node is triggered",
          "anyOf": [
            {
              "$ref": "#/$defs/Trigger"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "type": {
          "description": "Type of node (automatic or manual)",
          "$ref": "#/$defs/NodeType",
          "default": "automatic"
        }
      },
      "required": [
        "id",
        "name",
        "steps"
      ]
    },
    "NodeType": {
      "description": "Type of node",
      "oneOf": [
        {
          "description": "Automatic node (runs when dependencies are satisfied)",
          "type": "string",
          "const": "automatic"
        },
        {
          "description": "Manual node (requires explicit triggering)",
          "type": "string",
          "const": "manual"
        }
      ]
    },
    "Runtime": {
      "description": "Represents a runtime configuration",
      "type": "object",
      "properties": {
        "image": {
          "description": "Container image (for Docker and Podman)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "network": {
          "description": "Network mode for the container",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "options": {
          "description": "Additional container options",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "type": {
          "description": "Type of runtime",
          "$ref": "#/$defs/RuntimeType"
        },
        "user": {
          "description": "User to run as inside the container",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "working_dir": {
          "description": "Working directory inside the container",
          "type": [
            "string",
            "null"
          ],
          "default": null
        }
      },
      "required": [
        "type"
      ]
    },
    "RuntimeType": {
      "description": "Type of runtime",
      "oneOf": [
        {
          "description": "Direct execution on the host",
          "type": "string",
          "const": "direct"
        },
        {
          "description": "Docker container execution",
          "type": "string",
          "const": "docker"
        },
        {
          "description": "Podman container execution",
          "type": "string",
          "const": "podman"
        }
      ]
    },
    "SimpleSchema": {
      "description": "Simple schema system for workflow state and params validation\nRoot is always an object with properties",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/SimpleSchemaProperty"
      }
    },
    "SimpleSchemaProperty": {
      "description": "Represents a property in the schema with common metadata and type-specific fields",
      "type": "object",
      "properties": {
        "description": {
          "description": "Description of what this property represents",
          "type": [
            "string",
            "null"
          ]
        },
        "name": {
          "description": "Human-readable name for this property",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "oneOf": [
        {
          "description": "String type with optional oneOf and default",
          "type": "object",
          "properties": {
            "default": {
              "description": "Default value for the property",
              "type": [
                "string",
                "null"
              ]
            },
            "multi_line": {
              "description": "Whether the string is multi-line",
              "type": [
                "boolean",
                "null"
              ]
            },
            "oneOf": {
              "description": "Allows multiple schema alternatives for strings",
              "type": [
                "array",
                "null"
              ],
              "items": {
                "$ref": "#/$defs/SimpleSchemaVariant"
              }
            },
            "secret": {
              "description": "Whether the string is a secret",
              "type": [
                "boolean",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "const": "string"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "type": "object",
          "properties": {
            "default": {
              "description": "Default value for the property",
              "type": [
                "number",
                "null"
              ],
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "number"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Array type with required items schema",
          "type": "object",
          "properties": {
            "default": {
              "description": "Default value for the property",
              "type": [
                "string",
                "null"
              ]
            },
            "items": {
              "description": "Defines the schema of array items",
              "$ref": "#/$defs/SimpleSchemaProperty"
            },
            "type": {
              "type": "string",
              "const": "array"
            }
          },
          "required": [
            "type",
            "items"
          ]
        },
        {
          "description": "Object type with properties",
          "type": "object",
          "properties": {
            "default": {
              "description": "Default value for the property",
              "type": [
                "string",
                "null"
              ]
            },
            "properties": {
              "description": "Properties of the object",
              "type": [
                "object",
                "null"
              ],
              "additionalProperties": {
                "$ref": "#/$defs/SimpleSchemaProperty"
              }
            },
            "type": {
              "type": "string",
              "const": "object"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Boolean type with optional default",
          "type": "object",
          "properties": {
            "default": {
              "description": "Default value for the property",
              "type": [
                "boolean",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "const": "boolean"
            }
          },
          "required": [
            "type"
          ]
        }
      ]
    },
    "SimpleSchemaVariant": {
      "description": "Represents a variant in a oneOf schema for strings",
      "type": "object",
      "properties": {
        "enum": {
          "description": "For string types with enumeration, the allowed values",
          "type": [
            "array",
            "null"
          ],
          "items": {
            "type": "string"
          }
        },
        "type": {
          "description": "Type of this variant (always \"string\" for oneOf variants)",
          "type": "string"
        }
      },
      "required": [
        "type"
      ]
    },
    "Step": {
      "description": "Represents a step in a node",
      "type": "object",
      "properties": {
        "env": {
          "description": "Environment variables specific to this step",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          },
          "default": null
        },
        "if": {
          "description": "Conditional expression to determine if this step should be executed",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "name": {
          "description": "Human-readable name",
          "type": "string"
        }
      },
      "oneOf": [
        {
          "description": "Template to use for this step",
          "type": "object",
          "properties": {
            "use": {
              "$ref": "#/$defs/TemplateUse"
            }
          },
          "required": [
            "use"
          ]
        },
        {
          "description": "Script to run",
          "type": "object",
          "properties": {
            "run": {
              "type": "string"
            }
          },
          "required": [
            "run"
          ]
        },
        {
          "description": "ast-grep",
          "type": "object",
          "properties": {
            "ast-grep": {
              "$ref": "#/$defs/UseAstGrep"
            }
          },
          "required": [
            "ast-grep"
          ]
        },
        {
          "description": "JavaScript AST grep execution",
          "type": "object",
          "properties": {
            "js-ast-grep": {
              "$ref": "#/$defs/UseJSAstGrep"
            }
          },
          "required": [
            "js-ast-grep"
          ]
        },
        {
          "description": "Execute another codemod",
          "type": "object",
          "properties": {
            "codemod": {
              "$ref": "#/$defs/UseCodemod"
            }
          },
          "required": [
            "codemod"
          ]
        },
        {
          "description": "Execute AI agent with prompt",
          "type": "object",
          "properties": {
            "ai": {
              "$ref": "#/$defs/UseAI"
            }
          },
          "required": [
            "ai"
          ]
        }
      ],
      "required": [
        "name"
      ]
    },
    "Strategy": {
      "description": "Represents a strategy configuration",
      "type": "object",
      "properties": {
        "from_state": {
          "description": "State key to get matrix values from (for matrix strategy)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "type": {
          "description": "Type of strategy",
          "$ref": "#/$defs/StrategyType"
        },
        "values": {
          "description": "Matrix values (for matrix strategy)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "object",
            "additionalProperties": true
          }
        }
      },
      "required": [
        "type"
      ]
    },
    "StrategyType": {
      "description": "Type of strategy",
      "oneOf": [
        {
          "description": "Matrix strategy (run multiple instances with different inputs)",
          "type": "string",
          "const": "matrix"
        }
      ]
    },
    "Template": {
      "description": "Represents a reusable template",
      "type": "object",
      "properties": {
        "description": {
          "description": "Detailed description of what the template does",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "env": {
          "description": "Environment variables to inject into the container",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "id": {
          "description": "Unique identifier for the template",
          "type": "string"
        },
        "inputs": {
          "description": "Inputs for the template",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/TemplateInput"
          }
        },
        "name": {
          "description": "Human-readable name",
          "type": "string"
        },
        "outputs": {
          "description": "Outputs from the template",
          "type": "array",
          "default": [],
          "items": {
            "$ref": "#/$defs/TemplateOutput"
          }
        },
        "runtime": {
          "description": "Container runtime configuration",
          "anyOf": [
            {
              "$ref": "#/$defs/Runtime"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "steps": {
          "description": "Steps to execute within the template",
          "type": "array",
          "items": {
            "$ref": "#/$defs/Step"
          }
        }
      },
      "required": [
        "id",
        "name",
        "steps"
      ]
    },
    "TemplateInput": {
      "description": "Represents a template input",
      "type": "object",
      "properties": {
        "default": {
          "description": "Default value for the input",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "description": {
          "description": "Description of the input",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "name": {
          "description": "Name of the input",
          "type": "string"
        },
        "required": {
          "description": "Whether the input is required",
          "type": "boolean",
          "default": false
        },
        "type": {
          "description": "Type of the input (string, number, boolean)",
          "type": "string",
          "default": "string"
        }
      },
      "required": [
        "name"
      ]
    },
    "TemplateOutput": {
      "description": "Represents a template output",
      "type": "object",
      "properties": {
        "description": {
          "description": "Description of the output",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "name": {
          "description": "Name of the output",
          "type": "string"
        },
        "value": {
          "description": "Value of the output",
          "type": "string"
        }
      },
      "required": [
        "name",
        "value"
      ]
    },
    "TemplateUse": {
      "description": "Represents a template use in a step",
      "type": "object",
      "properties": {
        "inputs": {
          "description": "Inputs to pass to the template",
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "default": {}
        },
        "template": {
          "description": "Template ID to use",
          "type": "string"
        }
      },
      "required": [
        "template"
      ]
    },
    "Trigger": {
      "description": "Represents a trigger configuration",
      "type": "object",
      "properties": {
        "type": {
          "description": "Type of trigger",
          "$ref": "#/$defs/TriggerType"
        }
      },
      "required": [
        "type"
      ]
    },
    "TriggerType": {
      "description": "Type of trigger",
      "oneOf": [
        {
          "description": "Automatic trigger (runs when dependencies are satisfied)",
          "type": "string",
          "const": "automatic"
        },
        {
          "description": "Manual trigger (requires explicit triggering)",
          "type": "string",
          "const": "manual"
        }
      ]
    },
    "UseAI": {
      "type": "object",
      "properties": {
        "api_key": {
          "description": "LLM API key (optional, defaults to configured key or env var)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "dry_run": {
          "description": "Perform a dry run without making changes (optional, defaults to false)",
          "type": [
            "boolean",
            "null"
          ],
          "default": null
        },
        "enable_lakeview": {
          "description": "Enable lakeview mode (optional, defaults to true)",
          "type": [
            "boolean",
            "null"
          ],
          "default": null
        },
        "endpoint": {
          "description": "LLM API endpoint (optional, defaults to configured endpoint)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "env": {
          "description": "Environment variables to set for the AI agent execution (optional)",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          },
          "default": null
        },
        "llm_protocol": {
          "description": "LLM protocol to use (optional, defaults to openai)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "max_steps": {
          "description": "Maximum number of steps the AI agent can take (optional, defaults to 100)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "default": null,
          "minimum": 0
        },
        "model": {
          "description": "AI model to use (optional, defaults to configured model)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "prompt": {
          "description": "Prompt to send to the AI agent",
          "type": "string"
        },
        "system_prompt": {
          "description": "System prompt for the AI agent (optional)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "timeout_ms": {
          "description": "Timeout in milliseconds for AI agent execution (optional)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "default": null,
          "minimum": 0
        },
        "tools": {
          "description": "Tools available to the AI agent (optional, defaults to common tools)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "working_dir": {
          "description": "Working directory for AI agent execution (optional, defaults to current directory)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        }
      },
      "required": [
        "prompt"
      ]
    },
    "UseAstGrep": {
      "type": "object",
      "properties": {
        "allow_dirty": {
          "description": "Allow dirty files (optional, defaults to false)",
          "type": [
            "boolean",
            "null"
          ],
          "default": null
        },
        "base_path": {
          "description": "Base path for resolving relative globs (optional, defaults to current working directory)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "config_file": {
          "description": "Path to the ast-grep config file (.yaml)",
          "type": "string"
        },
        "exclude": {
          "description": "Exclude globs for files to skip (optional)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "include": {
          "description": "Include globs for files to search (optional, defaults to language-specific extensions)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "max_threads": {
          "description": "Set maximum number of concurrent threads (optional, defaults to CPU cores)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "default": null,
          "minimum": 0
        }
      },
      "required": [
        "config_file"
      ]
    },
    "UseCodemod": {
      "type": "object",
      "properties": {
        "args": {
          "description": "Command line arguments to pass to the codemod (optional)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "env": {
          "description": "Environment variables to set for the codemod execution (optional)",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": {
            "type": "string"
          },
          "default": null
        },
        "source": {
          "description": "Codemod source identifier (registry package or local path)",
          "type": "string"
        },
        "working_dir": {
          "description": "Working directory for codemod execution (optional, defaults to current directory)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        }
      },
      "required": [
        "source"
      ]
    },
    "UseJSAstGrep": {
      "type": "object",
      "properties": {
        "base_path": {
          "description": "Base path for resolving relative globs (optional, defaults to current working directory)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "dry_run": {
          "description": "Perform a dry run without making changes (optional, defaults to false)",
          "type": [
            "boolean",
            "null"
          ],
          "default": null
        },
        "exclude": {
          "description": "Exclude globs for files to skip (optional)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "include": {
          "description": "Include globs for files to search (optional, defaults to language-specific extensions)",
          "type": [
            "array",
            "null"
          ],
          "default": null,
          "items": {
            "type": "string"
          }
        },
        "js_file": {
          "description": "Path to the JavaScript file to execute",
          "type": "string"
        },
        "language": {
          "description": "Language to process (optional)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "max_threads": {
          "description": "Set maximum number of concurrent threads (optional, defaults to CPU cores)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint",
          "default": null,
          "minimum": 0
        }
      },
      "required": [
        "js_file"
      ]
    },
    "WorkflowParams": {
      "description": "Represents the params schema for a workflow",
      "type": "object",
      "properties": {
        "schema": {
          "description": "Object schema definition (root is always an object)",
          "$ref": "#/$defs/SimpleSchema",
          "default": {}
        }
      }
    },
    "WorkflowState": {
      "description": "Represents the state schema for a workflow",
      "type": "object",
      "properties": {
        "schema": {
          "description": "Object schema definition (root is always an object)",
          "$ref": "#/$defs/SimpleSchema",
          "default": {}
        }
      }
    }
  }
}